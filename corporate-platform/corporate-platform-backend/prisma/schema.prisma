datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum TransactionType {
  PURCHASE
  RETIREMENT
}

model Company {
  id           String        @id @default(cuid())
  name         String
  retirements  Retirement[]
  users        User[]
  orders       Order[]
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Credit {
  id           String               @id @default(cuid())
  projectId    String?  // Optional link to Project entity
  project      Project?             @relation(fields: [projectId], references: [id])
  projectName  String               // Denormalized for display/search
  country      String?
  methodology  String?
  standard     String?
  sdgs         String?
  vintageYear  Int?
  price        Float                @default(0) // Price per tCOâ‚‚
  totalAmount  Int
  available    Int
  retirements  Retirement[]
  cartItems    CartItem[]
  orderItems   OrderItem[]
  reservations CreditReservation[]
  auctions     Auction[]
  portfolioEntries PortfolioEntry[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  // Search optimization
  searchVector    String?
  featured        Boolean   @default(false)
  featuredUntil   DateTime?
  viewCount       Int       @default(0)
  purchaseCount   Int       @default(0)
  lastPurchasedAt DateTime?

  @@index([projectId])
  @@index([searchVector])
  @@index([featured])
  @@index([viewCount])
  @@index([purchaseCount])
}

model Retirement {
  id                String    @id @default(cuid())
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id])
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  
  creditId          String
  credit            Credit    @relation(fields: [creditId], references: [id])
  
  // Retirement details
  amount            Int
  purpose           String    // scope1, scope2, scope3, corporate, events, product
  purposeDetails    String?   // Additional context
  
  // Pricing
  priceAtRetirement Float
  
  // Certificate details
  certificateId     String?    @unique
  certificateUrl    String?
  
  // Blockchain
  transactionHash   String?
  transactionUrl    String?
  verifiedAt        DateTime?
  
  // Metadata
  retiredAt         DateTime  @default(now())
  
  // Relations
  certificate       RetirementCertificate?

  @@index([companyId])
  @@index([userId])
  @@index([creditId])
  @@index([purpose])
  @@index([retiredAt])
}

model RetirementCertificate {
  id                String    @id @default(cuid())
  retirementId      String    @unique
  retirement        Retirement @relation(fields: [retirementId], references: [id])
  
  certificateNumber String    @unique // e.g., "RET-2024-001234"
  pdfUrl            String
  ipfsHash          String?   // IPFS storage for permanence
  
  // Certificate data (snapshot)
  companyName       String
  retirementDate    DateTime
  creditProject     String
  creditAmount      Int
  creditPurpose     String
  transactionHash   String?
  
  createdAt         DateTime  @default(now())
}

model User {
  id                   String   @id @default(cuid())
  email                String   @unique
  password             String
  firstName            String
  lastName             String
  role                 String   @default("viewer")
  companyId            String
  company              Company  @relation(fields: [companyId], references: [id])
  refreshToken         String?
  lastLoginAt          DateTime?
  lastLoginIp          String?
  isActive             Boolean  @default(true)
  emailVerified        Boolean  @default(false)
  passwordResetToken   String?
  passwordResetExpires DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  sessions            Session[]
  retirements         Retirement[]
  orders              Order[]
  transactions        Transaction[]

  @@unique([companyId, email])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  refreshToken String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  isValid      Boolean  @default(true)
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime?

  @@index([refreshToken])
  @@index([expiresAt])
}

model Order {
  id              String             @id @default(cuid())
  orderNumber     String             @unique
  companyId       String
  company         Company            @relation(fields: [companyId], references: [id])
  userId          String
  user            User               @relation(fields: [userId], references: [id])
  status          OrderStatus        @default(PENDING)
  subtotal        Float
  serviceFee      Float              @default(0)
  total           Float
  paymentMethod   String?
  transactionHash String?
  paidAt          DateTime?
  createdAt       DateTime           @default(now())
  completedAt     DateTime?
  items           OrderItem[]
  statusEvents    OrderStatusEvent[]
  transactions    Transaction[]

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([orderNumber])
}

model OrderItem {
  id                   String @id @default(cuid())
  orderId              String
  order                Order  @relation(fields: [orderId], references: [id])
  creditId             String
  creditName           String
  projectName          String
  quantity             Int
  unitPrice            Float
  totalPrice           Float
  vintage              String?
  verificationStandard String?

  @@index([orderId])
}

model OrderStatusEvent {
  id        String      @id @default(cuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id])
  status    OrderStatus
  message   String?
  createdAt DateTime    @default(now())

  @@index([orderId])
  @@index([createdAt])
}

model Transaction {
  id              String          @id @default(cuid())
  type            TransactionType
  orderId         String?
  order           Order?          @relation(fields: [orderId], references: [id])
  companyId       String
  company         Company         @relation(fields: [companyId], references: [id])
  userId          String
  user            User            @relation(fields: [userId], references: [id])
  amount          Float
  description     String
  transactionHash String?
  createdAt       DateTime        @default(now())

  @@index([companyId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}
